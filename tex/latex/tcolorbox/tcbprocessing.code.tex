%% The LaTeX package tcolorbox - version 6.2.0pre2 (2023/10/27)
%% tcbprocessing.code.tex: Code for conditional processing
%%
%% -------------------------------------------------------------------------------------------
%% Copyright (c) 2006-2023 by Prof. Dr. Dr. Thomas F. Sturm <thomas dot sturm at unibw dot de>
%% -------------------------------------------------------------------------------------------
%%
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
%% This work has the LPPL maintenance status `author-maintained'.
%%
%% This work consists of all files listed in README
%%
\tcb@set@library@version{6.2.0pre2}

\RequirePackage{pdftexcmds}
\RequirePackage{shellesc}

\ExplSyntaxOn
\cs_new_protected:Npn \tcbproc@readmdfive #1#2
  {
    \tl_set:Ne \tcbproclastmdfivesum { \file_mdfive_hash:n {#1} }
    \file_if_exist_input:nF {#2}
      { \tl_set_eq:NN \tcbproclastmdfivesum \c_empty_tl }
  }
\ExplSyntaxOff

\def\tcbproc@writemdfive#1{%
  \tcb@allocate@tcb@out%
  \immediate\openout\tcb@out=#1%
  \immediate\write\tcb@out{\string\def\string\tcbproclastmdfivesum{\tcbprocmdfivesum}\@percentchar}%
  \immediate\closeout\tcb@out%
}

\newrobustcmd{\iftcb@process@on}[3]{%
  \tcbproc@readmdfive{#1}{#2}%
  \ifdefstrequal{\tcbproclastmdfivesum}{\tcbprocmdfivesum}{}{\tcbproc@writemdfive{#2}}%
  \expandafter\@firstoftwo%
}

\ExplSyntaxOn
% TODO: define it by \prg_new_protected_conditional:Npnn.
%       Then csname must contain ":".
\cs_new_protected:Npn \iftcb@process@conditional #1#2#3
  {
    \tcbproc@readmdfive {#1} {#2}
    \str_if_eq:ooTF { \tcbproclastmdfivesum } { \tcbprocmdfivesum }
      {
        \file_if_exist:nTF {#3}
          {
            \str_if_eq:eeTF { \file_timestamp:n {#2} }{ \file_timestamp:n {#3} }
              { \use_ii:ii }
              { \use_i:ii }
          }
          { \use_i:nn }
      }
      {
        \tcbproc@writemdfive{#2}
        \use_i:nn
      }
  }
\ExplSyntaxOff

\newrobustcmd{\iftcb@process@off}[3]{%
  \tcbproc@readmdfive{#1}{#2}%
  \ifdefstrequal{\tcbproclastmdfivesum}{\tcbprocmdfivesum}{}{\tcbproc@writemdfive{#2}}%
  \expandafter\@secondoftwo%
}%

\newrobustcmd{\tcbiffileprocess}[1]{%
  \ifcase\numexpr#1\relax%
    \expandafter\iftcb@process@on%
  \or%
    \expandafter\iftcb@process@conditional%
  \else%
    \expandafter\iftcb@process@off%
  \fi%
}
