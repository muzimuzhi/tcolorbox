%% The LaTeX package tcolorbox - version 6.2.0pre2 (2023/10/27)
%% tcbprocessing.code.tex: Code for conditional processing
%%
%% -------------------------------------------------------------------------------------------
%% Copyright (c) 2006-2023 by Prof. Dr. Dr. Thomas F. Sturm <thomas dot sturm at unibw dot de>
%% -------------------------------------------------------------------------------------------
%%
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
%% This work has the LPPL maintenance status `author-maintained'.
%%
%% This work consists of all files listed in README
%%
\tcb@set@library@version{6.2.0pre2}

\ExplSyntaxOn

\cs_new_protected:Npn \tcbproc@readmdfive #1#2
  {
    \tl_set:Ne \tcbproclastmdfivesum { \file_mdfive_hash:n {#1} }
    \file_if_exist_input:nF {#2}
      { \tl_set_eq:NN \tcbproclastmdfivesum \c_empty_tl }
  }

\cs_new_protected:Npn \tcbproc@writemdfive #1
{
  \tcb@allocate@tcb@out
  \iow_open:Nn \tcb@out {#1}
  \iow_now:Ne \tcb@out
    {
      \token_to_str:N \def \token_to_str:N \tcbproclastmdfivesum
        { \tcbprocmdfivesum } \c_percent_str
    }
  \iow_close:N \tcb@out
}

\cs_new_protected:Npn \iftcb@process@on #1#2#3
  {
    \tcbproc@readmdfive {#1} {#2}
    \str_if_eq:NNF \tcbproclastmdfivesum \tcbprocmdfivesum
      { \tcbproc@writemdfive{#2} }
    \use_i:ii
  }

% TODO: define it by \prg_new_protected_conditional:Npnn.
%       Then csname must contain ":".
\cs_new_protected:Npn \iftcb@process@conditional #1#2#3
  {
    \tcbproc@readmdfive {#1} {#2}
    \str_if_eq:NNTF \tcbproclastmdfivesum \tcbprocmdfivesum
      {
        \file_if_exist:nTF {#3}
          {
            \str_if_eq:eeTF { \file_timestamp:n {#2} }{ \file_timestamp:n {#3} }
              { \use_ii:ii }
              { \use_i:ii }
          }
          { \use_i:nn }
      }
      {
        \tcbproc@writemdfive {#2}
        \use_i:nn
      }
  }

\cs_new_protected:Npn \iftcb@process@off #1#2#3
  {
    \tcbproc@readmdfive {#1} {#2}
    \str_if_eq:NNF \tcbproclastmdfivesum \tcbprocmdfivesum
      { \tcbproc@writemdfive{#2} }
    \use_ii:nn
  }

\cs_new_protected:Npn \tcbiffileprocess #1
  {
    \int_case:nn {#1}
      {
        {0} { \iftcb@process@on }
        {1} { \iftcb@process@conditional }
        {2} { \iftcb@process@off }
      }
  }

\ExplSyntaxOff
